# 🔍 API 할당량 소진 문제 분석

## 📊 문제 발견

### 실행 로그 분석 결과

**실행 시간**: 2026-01-05 18:27 UTC (한국시간 오늘 새벽 3:27)  
**실행 상태**: ✅ 성공 (2분 33초)  
**데이터베이스 연결**: ✅ 성공  
**API 키 개수**: 3개

### ❌ 문제 발생

```
⚠️ API 키 할당량 소진: AIzaSyAQdvDGLrVzHYWz... (사용량: 9000)
⚠️ API 키 할당량 소진: AIzaSyCjxqyzAGEmC21u... (사용량: 9000)
⚠️ API 키 할당량 소진: AIzaSyBfD3EPz6DL6J_I... (사용량: 9000)
❌ 오류: 엔터테인먼트 모든 API 키의 할당량이 소진되었습니다.
```

**결과**:
- 총 수집: 0개
- 총 저장: 0개
- 사용된 API 키: 0/3개

---

## 🔍 원인 분석

### 문제 1: 할당량 추적이 메모리 기반

**현재 코드**:
```typescript
const dailyQuotaUsed = new Map<string, number>(); // 키별 일일 사용량
const exhaustedKeys = new Set<string>();
```

**문제점**:
- 할당량 추적이 메모리 변수로만 관리됨
- 스크립트가 실행될 때마다 초기화됨
- **하지만**: 이전 실행에서 이미 할당량을 사용했다면, 새로운 실행 시 할당량이 없음

### 문제 2: YouTube API 할당량 리셋 시간

**YouTube API 할당량 리셋**:
- 매일 UTC 00:00에 리셋됨
- 각 API 키당 일일 10,000 units

**스크립트 실행 시간**:
- 매일 UTC 18:00 (한국시간 오전 3시)
- 할당량이 리셋된 후 18시간 후 실행

**문제점**:
- 할당량이 리셋된 후에도 스크립트는 할당량이 소진되었다고 판단
- 이는 **이전 실행에서 할당량을 모두 사용**했기 때문

### 문제 3: 할당량 추적 로직

**현재 로직**:
1. 스크립트 시작 시 `dailyQuotaUsed`는 빈 Map
2. API 호출 시 `incrementApiUsage()`로 사용량 증가
3. 사용량이 `QUOTA_LIMIT_PER_KEY` (10000)에 도달하면 `exhaustedKeys`에 추가

**실제 문제**:
- 로그에서 "사용량: 9000"이라고 나오는데, 이는 **이전 실행에서 사용한 할당량**
- 새로운 실행에서는 할당량이 리셋되어야 하지만, 스크립트는 이를 알 수 없음
- 결과적으로 할당량이 소진되었다고 판단하여 아무것도 수집하지 않음

---

## 💡 해결 방법

### 방법 1: 할당량 추적을 데이터베이스에 저장 (권장)

**장점**:
- 할당량 사용량을 영구 저장
- 매일 리셋 로직 구현 가능
- 정확한 할당량 추적

**단점**:
- 데이터베이스 스키마 수정 필요
- 구현 복잡도 증가

### 방법 2: 할당량 체크 로직 개선 (간단)

**현재 문제**:
- 스크립트 시작 시 할당량이 소진되었다고 판단
- 실제로는 YouTube API에서 할당량이 리셋되었을 수 있음

**해결**:
- 스크립트 시작 시 할당량 체크를 실제 API 호출로 확인
- 403 에러가 나오면 할당량 소진, 아니면 사용 가능

### 방법 3: 할당량 사용량 초기화 (임시 해결)

**현재 코드 수정**:
```typescript
// 스크립트 시작 시 할당량 초기화
dailyQuotaUsed.clear();
exhaustedKeys.clear();
```

**문제점**:
- 이전 실행에서 사용한 할당량을 추적할 수 없음
- 여러 번 실행 시 할당량을 초과 사용할 수 있음

---

## 🎯 권장 해결 방법

### 즉시 해결: 할당량 초기화 로직 추가

스크립트 시작 시 할당량을 초기화하되, 실제 API 호출로 할당량 상태를 확인:

```typescript
// 스크립트 시작 시
dailyQuotaUsed.clear();
exhaustedKeys.clear();

// 실제 할당량 확인을 위한 테스트 API 호출
// (선택사항, 할당량 1 unit 사용)
```

### 장기 해결: 데이터베이스 기반 할당량 추적

1. 데이터베이스에 할당량 사용량 저장
2. 매일 UTC 00:00에 리셋
3. 정확한 할당량 추적

---

## 📋 현재 상태 요약

### ✅ 정상 작동 중
- GitHub Secrets 설정 완료
- GitHub Actions 워크플로우 실행 중
- 최근 5일 모두 성공적으로 실행됨
- 데이터베이스 연결 정상

### ❌ 문제 발생
- API 할당량이 모두 소진되어 데이터 수집 실패
- 할당량 추적 로직 문제로 인해 실제 할당량과 불일치

### 💡 해결 필요
- 할당량 추적 로직 개선
- 할당량 초기화 로직 추가
- 실제 API 할당량 상태 확인 로직 추가

---

## 🔧 수정 필요 사항

1. **할당량 초기화 로직 추가**
   - 스크립트 시작 시 할당량 초기화
   - 실제 API 호출로 할당량 상태 확인

2. **할당량 추적 개선**
   - 데이터베이스에 할당량 사용량 저장 (선택사항)
   - 매일 리셋 로직 구현

3. **에러 처리 개선**
   - 할당량 소진 시 더 명확한 메시지
   - 다음 실행 시간 안내
