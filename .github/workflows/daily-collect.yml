name: Daily Channel Collection

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 3ì‹œ (UTC 18:00)
    # ì£¼ë§(í† ìš”ì¼, ì¼ìš”ì¼)ì—ë„ ë°˜ë“œì‹œ ì‹¤í–‰
    - cron: '0 18 * * *'  # ë§¤ì¼ ì‹¤í–‰ (ì£¼ë§ í¬í•¨)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ìµœëŒ€ 60ë¶„ ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ ë°©ì§€)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --legacy-peer-deps
          echo "âœ… Dependencies installed"
        
      - name: Verify tsx installation
        run: |
          echo "ğŸ” Verifying tsx installation..."
          npx tsx --version || npm install -g tsx
          echo "âœ… tsx verified"
        
      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ”§ Generating Prisma Client..."
          npx prisma generate
          echo "âœ… Prisma Client generated"
        continue-on-error: false
        
      - name: Setup database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ—„ï¸ Setting up database..."
          npm run db:setup
          echo "âœ… Database setup completed"
        continue-on-error: false
        
      - name: Run daily collection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          YOUTUBE_API_KEYS: ${{ secrets.YOUTUBE_API_KEYS }}
        run: |
          echo "ğŸš€ Starting daily channel collection..."
          npm run collect:daily
          echo "âœ… Daily collection completed"
        continue-on-error: false
