name: Daily Channel Collection

on:
  schedule:
    # Îß§Ïùº ÌïúÍµ≠ÏãúÍ∞Ñ Ïò§Ï†Ñ 3Ïãú (UTC 18:00)
    # Ï£ºÎßê(ÌÜ†ÏöîÏùº, ÏùºÏöîÏùº)ÏóêÎèÑ Î∞òÎìúÏãú Ïã§Ìñâ
    - cron: '0 18 * * *'  # Îß§Ïùº Ïã§Ìñâ (Ï£ºÎßê Ìè¨Ìï®)
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ÏµúÎåÄ 60Î∂Ñ Ïã§Ìñâ (ÌÉÄÏûÑÏïÑÏõÉ Î∞©ÏßÄ)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Verify environment variables
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          YOUTUBE_API_KEYS: ${{ secrets.YOUTUBE_API_KEYS }}
        run: |
          echo "üîç Verifying environment variables..."
          npx tsx scripts/test-github-secrets.ts || {
            echo "‚ùå ERROR: Environment variables validation failed"
            exit 1
          }
        
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci --legacy-peer-deps || {
            echo "‚ùå ERROR: Failed to install dependencies"
            exit 1
          }
          echo "‚úÖ Dependencies installed"
        
      - name: Verify tsx installation
        run: |
          echo "üîç Verifying tsx installation..."
          if ! npx tsx --version; then
            echo "‚ö†Ô∏è tsx not found, installing globally..."
            npm install -g tsx || {
              echo "‚ùå ERROR: Failed to install tsx"
              exit 1
            }
          fi
          echo "‚úÖ tsx verified"
        
      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üîß Generating Prisma Client..."
          echo "DATABASE_URL length: ${#DATABASE_URL}"
          npx prisma generate || {
            echo "‚ùå ERROR: Failed to generate Prisma Client"
            echo "Check DATABASE_URL format"
            exit 1
          }
          echo "‚úÖ Prisma Client generated"
        
      - name: Verify database connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üîç Verifying database connection..."
          npx tsx -e "
            import { PrismaClient } from '@prisma/client';
            const prisma = new PrismaClient();
            prisma.\$connect()
              .then(() => {
                console.log('‚úÖ Database connection successful');
                return prisma.\$disconnect();
              })
              .catch((error) => {
                console.error('‚ùå Database connection failed:', error.message);
                process.exit(1);
              });
          " || {
            echo "‚ùå ERROR: Database connection failed"
            exit 1
          }
        
      - name: Setup database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üóÑÔ∏è Setting up database..."
          npm run db:setup || {
            echo "‚ùå ERROR: Database setup failed"
            exit 1
          }
          echo "‚úÖ Database setup completed"
        
      - name: Run daily collection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          YOUTUBE_API_KEYS: ${{ secrets.YOUTUBE_API_KEYS }}
        run: |
          echo "üöÄ Starting daily channel collection..."
          echo "YOUTUBE_API_KEYS length: ${#YOUTUBE_API_KEYS}"
          npm run collect:daily || {
            echo "‚ùå ERROR: Daily collection failed"
            exit 1
          }
          echo "‚úÖ Daily collection completed"
