name: Daily Channel Collection

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 3ì‹œ (UTC 18:00)
    # ì£¼ë§(í† ìš”ì¼, ì¼ìš”ì¼)ì—ë„ ë°˜ë“œì‹œ ì‹¤í–‰
    - cron: '0 18 * * *'  # ë§¤ì¼ ì‹¤í–‰ (ì£¼ë§ í¬í•¨)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ìµœëŒ€ 60ë¶„ ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ ë°©ì§€)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Verify environment variables
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          YOUTUBE_API_KEYS: ${{ secrets.YOUTUBE_API_KEYS }}
        run: |
          echo "ğŸ” Verifying environment variables..."
          npx tsx scripts/test-github-secrets.ts || {
            echo "âŒ ERROR: Environment variables validation failed"
            exit 1
          }
        
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --legacy-peer-deps || {
            echo "âŒ ERROR: Failed to install dependencies"
            exit 1
          }
          echo "âœ… Dependencies installed"
        
      - name: Verify tsx installation
        run: |
          echo "ğŸ” Verifying tsx installation..."
          if ! npx tsx --version; then
            echo "âš ï¸ tsx not found, installing globally..."
            npm install -g tsx || {
              echo "âŒ ERROR: Failed to install tsx"
              exit 1
            }
          fi
          echo "âœ… tsx verified"
        
      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ”§ Generating Prisma Client..."
          echo "DATABASE_URL length: ${#DATABASE_URL}"
          npx prisma generate || {
            echo "âŒ ERROR: Failed to generate Prisma Client"
            echo "Check DATABASE_URL format"
            exit 1
          }
          echo "âœ… Prisma Client generated"
        
      - name: Verify database connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ” Verifying database connection..."
          npx tsx -e "
            import { PrismaClient } from '@prisma/client';
            const prisma = new PrismaClient();
            prisma.\$connect()
              .then(() => {
                console.log('âœ… Database connection successful');
                return prisma.\$disconnect();
              })
              .catch((error) => {
                console.error('âŒ Database connection failed:', error.message);
                process.exit(1);
              });
          " || {
            echo "âŒ ERROR: Database connection failed"
            exit 1
          }
        
      - name: Setup database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ—„ï¸ Setting up database..."
          echo "ğŸ“‹ Step 1: Pushing Prisma schema to database..."
          npx prisma db push --accept-data-loss || {
            echo "âŒ ERROR: Failed to push Prisma schema"
            exit 1
          }
          echo "âœ… Prisma schema pushed"
          echo "ğŸ“‹ Step 2: Running database setup script..."
          npm run db:setup || {
            echo "âŒ ERROR: Database setup failed"
            echo "âš ï¸ This might be due to existing data or schema issues"
            exit 1
          }
          echo "âœ… Database setup completed"
        
      - name: Run daily collection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          YOUTUBE_API_KEYS: ${{ secrets.YOUTUBE_API_KEYS }}
        run: |
          echo "ğŸš€ Starting daily channel collection..."
          echo "YOUTUBE_API_KEYS length: ${#YOUTUBE_API_KEYS}"
          npm run collect:daily || {
            echo "âŒ ERROR: Daily collection failed"
            exit 1
          }
          echo "âœ… Daily collection completed"
