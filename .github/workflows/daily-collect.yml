name: Daily Channel Collection

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 3ì‹œ (UTC 18:00)
    # ì£¼ë§(í† ìš”ì¼, ì¼ìš”ì¼)ì—ë„ ë°˜ë“œì‹œ ì‹¤í–‰
    - cron: '0 18 * * *'  # ë§¤ì¼ ì‹¤í–‰ (ì£¼ë§ í¬í•¨)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ìµœëŒ€ 60ë¶„ ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ ë°©ì§€)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Verify environment variables
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          YOUTUBE_API_KEYS: ${{ secrets.YOUTUBE_API_KEYS }}
        run: |
          echo "ğŸ” Verifying environment variables..."
          npx tsx scripts/test-github-secrets.ts || {
            echo "âŒ ERROR: Environment variables validation failed"
            exit 1
          }
        
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --legacy-peer-deps || {
            echo "âŒ ERROR: Failed to install dependencies"
            exit 1
          }
          echo "âœ… Dependencies installed"
        
      - name: Verify tsx installation
        run: |
          echo "ğŸ” Verifying tsx installation..."
          if ! npx tsx --version; then
            echo "âš ï¸ tsx not found, installing globally..."
            npm install -g tsx || {
              echo "âŒ ERROR: Failed to install tsx"
              exit 1
            }
          fi
          echo "âœ… tsx verified"
        
      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ”§ Generating Prisma Client..."
          echo "DATABASE_URL length: ${#DATABASE_URL}"
          npx prisma generate || {
            echo "âŒ ERROR: Failed to generate Prisma Client"
            echo "Check DATABASE_URL format"
            exit 1
          }
          echo "âœ… Prisma Client generated"
        
      - name: Verify database connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ” Verifying database connection..."
          echo "DATABASE_URL format check..."
          
          # DATABASE_URL í˜•ì‹ ê²€ì¦
          if [[ -z "$DATABASE_URL" ]]; then
            echo "âŒ ERROR: DATABASE_URL is not set"
            exit 1
          fi
          
          # í¬íŠ¸ ë²ˆí˜¸ ì¶”ì¶œ ë° ê²€ì¦
          if echo "$DATABASE_URL" | grep -qE ":[0-9]+/"; then
            PORT=$(echo "$DATABASE_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
            if [[ -z "$PORT" ]] || [[ "$PORT" -lt 1 ]] || [[ "$PORT" -gt 65535 ]]; then
              echo "âŒ ERROR: Invalid port number in DATABASE_URL"
              echo "   Port must be between 1 and 65535"
              echo "   Current port: $PORT"
              exit 1
            fi
            echo "âœ… Port number validated: $PORT"
          else
            echo "âš ï¸  No port number found, using default port 5432"
          fi
          
          # Prisma ì—°ê²° í…ŒìŠ¤íŠ¸
          npx tsx -e "
            import { PrismaClient } from '@prisma/client';
            const prisma = new PrismaClient();
            prisma.\$connect()
              .then(() => {
                console.log('âœ… Database connection successful');
                return prisma.\$disconnect();
              })
              .catch((error) => {
                console.error('âŒ Database connection failed:', error.message);
                if (error.message.includes('invalid port number')) {
                  console.error('ğŸ’¡ Fix: Check DATABASE_URL port number (1-65535)');
                  console.error('ğŸ’¡ Fix: Re-copy External Connection String from Render');
                } else if (error.message.includes('connection string')) {
                  console.error('ğŸ’¡ Fix: Check DATABASE_URL format: postgresql://user:password@host:port/database');
                  console.error('ğŸ’¡ Fix: Special characters may need URL encoding');
                }
                process.exit(1);
              });
          " || {
            echo "âŒ ERROR: Database connection failed"
            echo "ğŸ’¡ Check DATABASE_URL format in GitHub Secrets"
            exit 1
          }
        
      - name: Setup database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # í¬íŠ¸ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì¶”ê°€
          if ! echo "$DATABASE_URL" | grep -qE ":[0-9]+/"; then
            if echo "$DATABASE_URL" | grep -qE "postgresql://[^@]+@[^/]+/"; then
              export DATABASE_URL=$(echo "$DATABASE_URL" | sed 's|\(postgresql://[^@]\+@[^/]\+\)/|\1:5432/|')
            elif echo "$DATABASE_URL" | grep -qE "postgres://[^@]+@[^/]+/"; then
              export DATABASE_URL=$(echo "$DATABASE_URL" | sed 's|\(postgres://[^@]\+@[^/]\+\)/|\1:5432/|')
            fi
          fi
          
          echo "ğŸ—„ï¸ Setting up database..."
          echo "ğŸ“‹ Step 1: Pushing Prisma schema to database..."
          npx prisma db push --accept-data-loss || {
            echo "âŒ ERROR: Failed to push Prisma schema"
            exit 1
          }
          echo "âœ… Prisma schema pushed"
          echo "ğŸ“‹ Step 2: Running database setup script..."
          npm run db:setup || {
            echo "âŒ ERROR: Database setup failed"
            echo "âš ï¸ This might be due to existing data or schema issues"
            exit 1
          }
          echo "âœ… Database setup completed"
        
      - name: Run daily collection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          YOUTUBE_API_KEYS: ${{ secrets.YOUTUBE_API_KEYS }}
        run: |
          echo "ğŸš€ Starting daily channel collection..."
          echo "YOUTUBE_API_KEYS length: ${#YOUTUBE_API_KEYS}"
          npm run collect:daily || {
            echo "âŒ ERROR: Daily collection failed"
            exit 1
          }
          echo "âœ… Daily collection completed"
