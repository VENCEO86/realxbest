# 📅 자동 수집 스케줄 및 데이터 롤링 정책

## 🕐 수집 주기

### 현재 설정
- **주기**: 매일 실행 (주말 포함)
- **시간**: 한국시간 오전 3시 (UTC 18:00)
- **방법**: GitHub Actions 자동 실행

### 스케줄 상세
- **평일**: 매일 오전 3시 실행
- **주말**: 매일 오전 3시 실행 (토요일, 일요일 포함)
- **수동 실행**: 언제든지 GitHub Actions에서 수동 실행 가능

---

## 🔄 데이터베이스 롤링 정책

### 기존 채널 처리 방식

1. **중복 체크**
   - 새로 수집한 채널 ID가 이미 DB에 존재하는지 확인
   - 존재하면: **업데이트만 수행** (새로 저장하지 않음)
   - 존재하지 않으면: **새로 저장**

2. **데이터 업데이트**
   - 기존 채널의 경우 다음 정보를 자동 업데이트:
     - 채널 이름
     - 구독자 수
     - 총 조회수
     - 비디오 개수
     - 프로필 이미지 URL
     - 핸들 (@username)
     - 설명
     - 마지막 업데이트 시간 (`lastUpdated`)

3. **롤링 효과**
   - ✅ 기존 데이터가 최신 상태로 유지됨
   - ✅ 중복 데이터 생성 방지
   - ✅ 데이터베이스 용량 최적화
   - ✅ 광고 삽입을 위한 안정적인 데이터 풀 유지

---

## 📊 데이터 보장 정책

### 최소 데이터 보장
- **국가별/카테고리별 최소 100개 이상** 보장
- 광고 삽입을 위한 충분한 데이터 확보
- 최소 개수 미달 시 우선 수집

### 목표 데이터
- **국가별/카테고리별 목표 300개**
- 최소 100개 보장 후 목표 300개까지 점진적 확보

### 데이터 품질 기준
- **최소 구독자**: 1,000명 이상
- **최소 조회수**: 10,000회 이상
- **자동 필터링**: 기준 미달 채널은 제외

---

## 🎯 수집 우선순위

1. **1순위**: 최소 개수 미달 국가/카테고리
   - 100개 미만인 경우 긴급 수집

2. **2순위**: 목표 개수 미달 국가/카테고리
   - 100개 이상 300개 미만인 경우 일반 수집

3. **3순위**: 목표 달성 국가/카테고리
   - 300개 이상인 경우 기존 채널 업데이트만 수행

---

## 📈 수집 통계

### 수집 과정에서 표시되는 정보
- 현재 채널 수 / 목표 채널 수
- 최소 보장 개수 상태
- 수집 필요 개수
- 진행률 (%)

### 완료 후 통계
- 총 수집된 채널 수
- 새로 저장된 채널 수
- 사용된 API 키 수
- 할당량 소진 여부

---

## ⚙️ 자동화 설정

### GitHub Actions
- **파일**: `.github/workflows/daily-collect.yml`
- **스케줄**: 매일 UTC 18:00 (한국시간 오전 3시)
- **필요한 Secrets**:
  - `DATABASE_URL`
  - `YOUTUBE_API_KEYS`

### Render Cron Job (선택사항)
- **스케줄**: `0 3 * * *` (매일 오전 3시)
- **엔드포인트**: `/api/cron/daily-collect`
- **필요한 환경 변수**:
  - `DATABASE_URL`
  - `YOUTUBE_API_KEYS`
  - `CRON_SECRET`

---

## 🔍 데이터 롤링 확인 방법

### 데이터베이스 쿼리 예시
```sql
-- 국가별/카테고리별 채널 수 확인
SELECT 
  country,
  c.name as category,
  COUNT(*) as channel_count
FROM youtube_channels yc
JOIN categories c ON yc.category_id = c.id
WHERE yc.subscriber_count >= 1000
  AND yc.total_view_count >= 10000
GROUP BY country, c.name
ORDER BY channel_count DESC;

-- 최근 업데이트된 채널 확인
SELECT 
  channel_name,
  subscriber_count,
  last_updated
FROM youtube_channels
ORDER BY last_updated DESC
LIMIT 20;
```

### 관리자 페이지에서 확인
- 랭킹 페이지에서 국가/카테고리별 필터링
- 각 필터 조합에서 최소 100개 이상 표시 확인

---

## 📝 요약

✅ **수집 주기**: 매일 실행 (주말 포함)
✅ **데이터 롤링**: 기존 채널 자동 업데이트
✅ **최소 보장**: 국가별/카테고리별 100개 이상
✅ **목표**: 국가별/카테고리별 300개
✅ **광고 삽입**: 충분한 데이터 풀 확보

